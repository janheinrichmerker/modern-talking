name: CI

on:
  push:

jobs:
  build-latex-paper:
    name: "ğŸ—ï¸ Build LaTeX paper"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v4
      - name: "ğŸ—ï¸ Compile paper"
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: paper
          root_file: emnlp2021.tex
      - name: "ğŸ“¤ Upload paper"
        uses: actions/upload-artifact@v4
        with:
          path: paper/emnlp2021.pdf
          name: Paper
  build-latex-talk:
    name: "ğŸ—ï¸ Build LaTeX talk"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v4
      - name: "ğŸ—ï¸ Compile talk"
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: talk
          root_file: talk.tex
      - name: "ğŸ“¤ Upload talk"
        uses: actions/upload-artifact@v4
        with:
          path: talk/talk.pdf
          name: Talk
  build-latex-short-talk:
    name: "ğŸ—ï¸ Build LaTeX short talk"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v4
      - name: "ğŸ—ï¸ Compile short talk"
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: talk
          root_file: short-talk.tex
      - name: "ğŸ“¤ Upload short talk"
        uses: actions/upload-artifact@v4
        with:
          path: talk/short-talk.pdf
          name: Short Talk
  python-build:
    name: "ğŸ—ï¸ Build Python wheels"
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Check-out"
      uses: actions/checkout@v4
    - name: "ğŸ§° Install Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: pip
        cache-dependency-path: pyproject.toml
    - name: "ğŸ§° Install dependencies"
      run: pip install build twine
    - name: "ğŸ—ï¸ Build Python wheels"
      run: python -m build
    - name: "ğŸ§ª Check package bundles"
      run: twine check dist/*
    - name: "ğŸ“¤ Upload Python wheels"
      uses: actions/upload-artifact@v4
      with:
        name: wheels
        path: dist
  python-code-format:
    name: "ğŸ” Check Python code format"
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Check-out"
      uses: actions/checkout@v4
    - name: "ğŸ§° Install Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: pip
        cache-dependency-path: pyproject.toml
    - name: "ğŸ§° Install dependencies"
      run: pip install .[tests]
    - name: "ğŸ” Check Python code format"
      run: flake8 --exclude=./modern_talking/evaluation/track_1_kp_matching.py
  python-lint:
    name: "ğŸ” Lint Python code"
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Check-out"
      uses: actions/checkout@v4
    - name: "ğŸ§° Install Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: pip
        cache-dependency-path: pyproject.toml
    - name: "ğŸ§° Install dependencies"
      run: pip install .[tests]
    - name: "ğŸ” Lint Python code"
      run: pylint -E modern_talking
  python-test:
    name: "ğŸ§ª Test Python code"
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Check-out"
      uses: actions/checkout@v4
    - name: "ğŸ§° Install Protoc"
      run: sudo apt install protobuf-compiler
    - name: "ğŸ§° Install Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: pip
        cache-dependency-path: pyproject.toml
    - name: "ğŸ§° Install dependencies"
      run: pip install .[tests]
    - name: "ğŸ§ª Test Python code"
      run: pytest --cov --cov-report=term --cov-report=xml
    - name: "ğŸ“¤ Upload coverage to Codecov"
      uses: codecov/codecov-action@v4
      if: matrix.python == '3.11'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
  docker-build:
    name: "ğŸ—ï¸ Build Docker image"
    runs-on: ubuntu-latest
    steps:
    - name: "ğŸ“¥ Check-out"
      uses: actions/checkout@v4
    - name: "ğŸ§° Set up QEMU"
      uses: docker/setup-qemu-action@v3
    - name: "ğŸ§° Set up Docker Buildx"
      uses: docker/setup-buildx-action@v3
    - name: "ğŸ—ï¸ Build Docker image"
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
